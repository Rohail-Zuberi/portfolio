<section class="relative z-20 w-full max-w-4xl mx-auto mt-14 px-7 xl:px-0">
  <div class="rounded-2xl border border-dashed border-neutral-300 p-5 dark:border-neutral-700 sm:p-6">
    <h2 class="text-2xl font-bold tracking-tight text-neutral-900 dark:text-neutral-100">Send a Message</h2>
    <p id="contact-help" class="mt-2 text-sm text-neutral-600 dark:text-neutral-400">
      Write your subject and message. It will be sent directly to my inbox.
    </p>

    <form id="contact-form" class="mt-5 space-y-4" novalidate>
      <div>
        <label for="contact-subject" class="mb-1 block text-sm font-medium text-neutral-800 dark:text-neutral-200">Subject</label>
        <input
          id="contact-subject"
          name="subject"
          type="text"
          required
          maxlength="120"
          autocomplete="off"
          class="w-full rounded-md border border-dashed border-neutral-400 bg-white px-3 py-2 text-sm text-neutral-900 outline-none transition focus:border-neutral-700 dark:border-neutral-600 dark:bg-neutral-900 dark:text-neutral-100 dark:focus:border-neutral-300"
        />
      </div>

      <div>
        <label for="contact-body" class="mb-1 block text-sm font-medium text-neutral-800 dark:text-neutral-200">Message</label>
        <textarea
          id="contact-body"
          name="body"
          required
          maxlength="2000"
          rows="6"
          class="w-full rounded-md border border-dashed border-neutral-400 bg-white px-3 py-2 text-sm text-neutral-900 outline-none transition focus:border-neutral-700 dark:border-neutral-600 dark:bg-neutral-900 dark:text-neutral-100 dark:focus:border-neutral-300"
        ></textarea>
        <p
          id="contact-body-counter"
          class="mt-1 text-xs text-neutral-500 dark:text-neutral-400"
          aria-live="polite"
        >
          2000/2000
        </p>
      </div>

      <button
        id="contact-submit"
        type="submit"
        class="inline-flex items-center justify-center rounded-full border border-neutral-900 bg-neutral-900 px-5 py-2.5 text-sm font-semibold text-neutral-100 transition hover:bg-white hover:text-neutral-900 dark:border-neutral-100 dark:bg-neutral-100 dark:text-neutral-900 dark:hover:bg-neutral-900 dark:hover:text-neutral-100"
      >
        Send Message
      </button>
      <p
        id="contact-status"
        class="text-sm text-neutral-600 dark:text-neutral-400"
        role="status"
        aria-live="polite"
      ></p>
    </form>
  </div>
</section>

<script>
  const contactForm = document.querySelector("#contact-form");
  const bodyInput = document.querySelector("#contact-body");
  const bodyCounter = document.querySelector("#contact-body-counter");

  const updateBodyCounter = () => {
    if (!(bodyInput instanceof HTMLTextAreaElement) || !(bodyCounter instanceof HTMLElement)) {
      return;
    }

    const maxLength = bodyInput.maxLength;
    const remaining = maxLength - bodyInput.value.length;
    bodyCounter.textContent = `${remaining}/${maxLength}`;
  };

  updateBodyCounter();

  if (bodyInput instanceof HTMLTextAreaElement) {
    bodyInput.addEventListener("input", updateBodyCounter);
  }

  if (contactForm instanceof HTMLFormElement) {
    contactForm.addEventListener("submit", (event) => {
      event.preventDefault();

      const subjectInput = document.querySelector("#contact-subject");
      const bodyInput = document.querySelector("#contact-body");

      if (!(subjectInput instanceof HTMLInputElement) || !(bodyInput instanceof HTMLTextAreaElement)) {
        return;
      }

      if (!subjectInput.checkValidity() || !bodyInput.checkValidity()) {
        contactForm.reportValidity();
        return;
      }

      const submitButton = document.querySelector("#contact-submit");
      const statusElement = document.querySelector("#contact-status");

      if (!(submitButton instanceof HTMLButtonElement) || !(statusElement instanceof HTMLElement)) {
        return;
      }

      submitButton.disabled = true;
      statusElement.textContent = "Sending...";

      fetch("/api/contact", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          subject: subjectInput.value.trim(),
          body: bodyInput.value.trim(),
        }),
      })
        .then(async (response) => {
          if (!response.ok) {
            const payload = await response.json().catch(() => ({}));
            throw new Error(payload?.message || "Unable to send message.");
          }

          contactForm.reset();
          updateBodyCounter();
          statusElement.textContent = "Message sent successfully.";
        })
        .catch((error) => {
          statusElement.textContent = error instanceof Error ? error.message : "Unable to send message.";
        })
        .finally(() => {
          submitButton.disabled = false;
        });
    });
  }
</script>
